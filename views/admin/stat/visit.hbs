<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>방문 통계 - {{APP}}</title>

  {{>ad-style}}

</head>

<body class="az-body az-body-sidebar az-body-dashboard-nine az-white-box">

  {{>ad-hdn}}

  <div id="progress"></div>

  {{>ad-menu active='stvisit'}}

  <div class="az-content az-content-dashboard-nine">

    {{>ad-header}}

    <div class="az-content-header">
      <div class="az-content-header-top">
        <div>
          <h2 class="az-content-title mg-b-5 mg-b-lg-8">방문 통계</h2>
          <p class="mg-b-0">지난 기간동안 홈페이지에 접속한 방문자 현황입니다.</p>
        </div>
      </div>

    </div>
    <div class="az-content-body">

      <div class="row row-sm">
        <div class="col-lg-12 mg-t-0">
          <div class="card card-dashboard-four">
            <div class="card-header">
              <h6 class="card-title mg-b-5-f">연간 방문자 수</h6>
              <p class="mg-b-20 card-text" style="font-size: 12px;">연도별 방문자수 통계입니다.</p>
            </div>
            <div class="card-body row">
              <div class="col-12 mg-b-20" style="min-height: 200px;">
                <canvas id="visitChart"></canvas>
              </div>
              <div class="col-12">
                <div class="table-responsive">
                  <table class="table az-table-reference">
                    <tbody>
                      <tr>
                        <td class="td-header wd-10p"></td>
                        <td class="text-center" style="width: 6%;">1월</td>
                        <td class="text-center" style="width: 6%;">2월</td>
                        <td class="text-center" style="width: 6%;">3월</td>
                        <td class="text-center" style="width: 6%;">4월</td>
                        <td class="text-center" style="width: 6%;">5월</td>
                        <td class="text-center" style="width: 6%;">6월</td>
                        <td class="text-center" style="width: 6%;">7월</td>
                        <td class="text-center" style="width: 6%;">8월</td>
                        <td class="text-center" style="width: 6%;">9월</td>
                        <td class="text-center" style="width: 6%;">10월</td>
                        <td class="text-center" style="width: 6%;">11월</td>
                        <td class="text-center" style="width: 6%;">12월</td>
                        <td class="text-center" style="width: 6%;">합계</td>
                        <td class="text-center" style="width: 6%;">평균</td>
                      </tr>
                      {{#each yearArray}}
                      <tr>
                        {{#each this}}
                        <td class="text-center {{#eq @index 0}}td-header{{/eq}}">{{this}}</td>
                        {{/each}}
                        <td class="text-center">{{visitSum ../yearArray}}</td>
                        <td class="text-center">{{visitAvg ../yearArray}}</td>
                      </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-7 col-xl-7 mg-t-20">
          <div class="card card-body ht-xl-100p card-dashboard-five">
            <h6 class="card-title tx-14 mg-b-10">월별 방문자 수</h6>
            <p class="mg-b-15 card-text">선택한 연도의 해당 월에 대한 일별 방문자 수 통계입니다.</p>
            <form method="POST" onsubmit="return APP.search()">
              <div class="form-group form-filter">
                <input id="ym" type="text" name="ym"
                  class="form-control air-datepicker d-inline input-sm wd-50p wd-md-30p mg-b-15"
                  placeholder="연월을 선택해주세요." autocomplete="off">
                <input id="ymSubmit" type="submit" class="submit btn-sm btn-indigo mg-l-10" value="조회">
              </div>
            </form>
            <div class="table-responsive">
              <div class="text-center mg-b-15" style="font-size: 18px;"><span id="monthDataY"></span><span
                  class="mg-r-5">년</span><span id="monthDataM"></span>월</div>
              <table class="table az-table-reference">
                <tbody>
                  <tr>
                    <td class="td-header text-center">1일</td>
                    <td class="td-header text-center">2일</td>
                    <td class="td-header text-center">3일</td>
                    <td class="td-header text-center">4일</td>
                    <td class="td-header text-center">5일</td>
                    <td class="td-header text-center">6일</td>
                    <td class="td-header text-center">7일</td>
                  </tr>
                  <tr>
                    <td class="text-center month-data-field" id="monthData1">-</td>
                    <td class="text-center month-data-field" id="monthData2">-</td>
                    <td class="text-center month-data-field" id="monthData3">-</td>
                    <td class="text-center month-data-field" id="monthData4">-</td>
                    <td class="text-center month-data-field" id="monthData5">-</td>
                    <td class="text-center month-data-field" id="monthData6">-</td>
                    <td class="text-center month-data-field" id="monthData7">-</td>
                  </tr>
                  <tr>
                    <td class="td-header text-center">8일</td>
                    <td class="td-header text-center">9일</td>
                    <td class="td-header text-center">10일</td>
                    <td class="td-header text-center">11일</td>
                    <td class="td-header text-center">12일</td>
                    <td class="td-header text-center">13일</td>
                    <td class="td-header text-center">14일</td>
                  </tr>
                  <tr>
                    <td class="text-center month-data-field" id="monthData8">-</td>
                    <td class="text-center month-data-field" id="monthData9">-</td>
                    <td class="text-center month-data-field" id="monthData10">-</td>
                    <td class="text-center month-data-field" id="monthData11">-</td>
                    <td class="text-center month-data-field" id="monthData12">-</td>
                    <td class="text-center month-data-field" id="monthData13">-</td>
                    <td class="text-center month-data-field" id="monthData14">-</td>
                  </tr>
                  <tr>
                    <td class="td-header text-center">15일</td>
                    <td class="td-header text-center">16일</td>
                    <td class="td-header text-center">17일</td>
                    <td class="td-header text-center">18일</td>
                    <td class="td-header text-center">19일</td>
                    <td class="td-header text-center">20일</td>
                    <td class="td-header text-center">21일</td>
                  </tr>
                  <tr>
                    <td class="text-center month-data-field" id="monthData15">-</td>
                    <td class="text-center month-data-field" id="monthData16">-</td>
                    <td class="text-center month-data-field" id="monthData17">-</td>
                    <td class="text-center month-data-field" id="monthData18">-</td>
                    <td class="text-center month-data-field" id="monthData19">-</td>
                    <td class="text-center month-data-field" id="monthData20">-</td>
                    <td class="text-center month-data-field" id="monthData21">-</td>
                  </tr>
                  <tr>
                    <td class="td-header text-center">22일</td>
                    <td class="td-header text-center">23일</td>
                    <td class="td-header text-center">24일</td>
                    <td class="td-header text-center">25일</td>
                    <td class="td-header text-center">26일</td>
                    <td class="td-header text-center">27일</td>
                    <td class="td-header text-center">28일</td>
                  </tr>
                  <tr>
                    <td class="text-center month-data-field" id="monthData22">-</td>
                    <td class="text-center month-data-field" id="monthData23">-</td>
                    <td class="text-center month-data-field" id="monthData24">-</td>
                    <td class="text-center month-data-field" id="monthData25">-</td>
                    <td class="text-center month-data-field" id="monthData26">-</td>
                    <td class="text-center month-data-field" id="monthData27">-</td>
                    <td class="text-center month-data-field" id="monthData28">-</td>
                  </tr>
                  <tr>
                    <td class="td-header text-center">29일</td>
                    <td class="td-header text-center">30일</td>
                    <td class="td-header text-center">31일</td>
                    <td class="td-header text-center"></td>
                    <td class="td-header text-center"></td>
                    <td class="td-header text-center"></td>
                    <td class="td-header text-center"></td>
                  </tr>
                  <tr>
                    <td class="text-center month-data-field" id="monthData29">-</td>
                    <td class="text-center month-data-field" id="monthData30">-</td>
                    <td class="text-center month-data-field" id="monthData31">-</td>
                    <td class="text-center month-data-field"></td>
                    <td class="text-center month-data-field"></td>
                    <td class="text-center month-data-field"></td>
                    <td class="text-center month-data-field"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-5 mg-t-20">
          <div class="card card-dashboard-five">
            <div class="card-header">
              <h6 class="card-title">시간대별 방문자 수</h6>
              <span class="card-text">시간과 요일에 따른 방문자 수 통계입니다.</span>
            </div>
            <div class="card-body">
              <div id="dayTime" style="height: 480px;"></div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  {{>ad-script}}
  <script>
    window.APP = {
      search: function () { // 필터링 조회
        // 유효성 검사
        var filter = event.target;
        if (filter.ym.value == '') {
          Swal.fire({ type: 'error', title: '오류', text: '해당 월을 선택해주세요.', confirmButtonColor: '#5b47fb', confirmButtonText: '확인' });
          return false;
        }

        var form = $(event.target).serializeObject();
        var year = parseInt(form.ym.substring(0, form.ym.lastIndexOf('-')));
        var month = parseInt(form.ym.substring(form.ym.lastIndexOf('-') + 1));

        AJAX.get('/visit/month', form)
          .then(function (res) {
            var monthData = res.monthArray;
            $('#monthDataY').text(year);
            $('#monthDataM').text(month);
            $('.month-data-field').html('');
            for (var i = 0; i < 32; i++) {
              var el = monthData[i];
              if (!el && el != 0) el = '-';
              $('#monthData' + (i + 1)).text(el);
            }
          });

        return false;

      },
      init: function () { // 초기 스크립트 실행

        // 기간 차트 초기화
        var vd = {{{ yearChart.data
    }}};
    var last = vd[vd.length - 1] ? vd[vd.length - 1][0] : moment().format('YYYY');

    // 데이트 피커
    $('.air-datepicker').datepicker({
      language: 'ko',
      autoClose: true,
      view: 'months',
      minView: 'months',
      dateFormat: 'yyyy-mm',
      maxDate: moment().toDate(),
      minDate: moment(last).toDate()
    });

    var colorSet = ['#3366ff', '#6f42c1', '#0d233a', '#8bbc21', '#910000', '#1aadce', '#492970',
      '#f28f43', '#77a1e5', '#c42525', '#a6c96a', '#4572A7', '#AA4643', '#89A54E', '#80699B', '#3D96AE',
      '#DB843D', '#92A8CD', '#A47D7C', '#B5CA92'];

    // 연간 월간 차트 초기화
    var visitChart = new Chart(document.getElementById('visitChart'), {
      type: 'line',
      data: {
        labels: ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'],
        datasets: (function () {
          var dsts = [];
          for (var i = 0; i < vd.length; i++) {
            dsts.push({
              label: vd[i][0],
              data: vd[i].slice(1, vd[i].length),
              borderColor: colorSet[i],
              borderWidth: 1,
              fill: false
            });
          }
          return dsts;
        })()
      },
      options: {
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            display: false
          }
        },
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              fontSize: 10,
            }
          }],
          xAxes: [{
            ticks: {
              beginAtZero: true,
              fontSize: 11
            }
          }]
        },
        plugins: {
          datalabels: {
            display: false
          }
        }
      }
    });

    // 월별 방문수 초기화
    var monthData = {{{ monthArray.data }}};
    $('#ym').datepicker().data('datepicker').selectDate(moment().toDate());
    var ym = $('#ym').val();
    var year = parseInt(ym.substring(0, ym.lastIndexOf('-')));
    var month = parseInt(ym.substring(ym.lastIndexOf('-') + 1));

    $('#monthDataY').text(year);
    $('#monthDataM').text(month);
    $('.month-data-field').html('');

    for (var i = 0; i < 32; i++) {
      var el = monthData[i];
      if (!el && el != 0) el = '-';
      $('#monthData' + (i + 1)).text(el);
    }

    // 시간대별 방문자 수 차트 초기화
    var hours = ['23시', '22시', '21시', '20시', '19시', '18시', '17시', '16시',
      '15시', '14시', '13시', '12시', '11시',
      '10시', '9시', '8시', '7시', '6시',
      '5시', '4시', '3시', '2시', '1시', '0시'
    ];

    var days = ['일요일', '월요일', '화요일',
      '수요일', '목요일', '금요일', '토요일'
    ];

    var dayTimeData = {{{ dtArray.data }}};
    var maxDayTimeData = Math.max.apply(null, dayTimeData) || 0;
    var data = (function () {
      var el = []
      var ct = 0;
      for (var i = 0; i <= 6; i++) {
        for (var j = 0; j <= 23; j++) {
          el.push(Array.of(i, j, dayTimeData[ct++] || 0));
        }
      }

      return el;
    })();

    var optionMap = {
      tooltip: {
        position: 'top',
        formatter: function (params, ticket, callback) {
          var colorSpan = function (color) { return '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:' + color + '"></span>' };
          return params.name + ' ' + (params.data[1] - 23) * -1 + '시<br/>' + colorSpan(params.color) + ' ' + params.data[2] + ' 명'
        }
      },
      animation: false,
      grid: {
        top: '3%',
        right: '5%',
        left: '13%',
        bottom: '3%',
        height: '90%',
      },
      xAxis: {
        type: 'category',
        data: days,
        axisTick: {
          show: false
        },
        splitArea: {
          show: true
        }
      },
      yAxis: {
        type: 'category',
        data: hours,
        axisTick: {
          show: false
        },
        splitArea: {
          show: true
        }
      },
      visualMap: {
        show: false,
        min: 0,
        max: maxDayTimeData,
        inRange: {
          color: ['#f9fcff', '#0000FF']
        }
      },
      series: [{
        name: '방문자',
        type: 'heatmap',
        data: data,
        label: {
          normal: {
            show: false
          }
        },
        itemStyle: {
          emphasis: {
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }],
      plugins: {
        datalabels: {
          display: false
        }
      }
    };

    var dayTimeChart = echarts.init(document.getElementById('dayTime'));
    dayTimeChart.setOption(optionMap, true);
    dayTimeChart.resize();

    }
    }

    $(document).ready(function () {
      APP.init();
    });
  </script>

</body>

</html>